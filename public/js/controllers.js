// Generated by CoffeeScript 1.6.2
(function() {
  var controllers;

  controllers = angular.module('app.controllers', []);

  controllers.controller("MainCtrl", [
    "$scope", "Restangular", "$window", "$location", "$rootScope", "geocoder", "$timeout", function($scope, Restangular, $window, $location, $rootScope, geocoder, $timeout) {
      var _this = this;

      $scope.pin = new google.maps.MarkerImage("/images/pin.png", null, null, null, new google.maps.Size(35, 35));
      $scope.markers = [];
      $scope.mapOptions = {
        backgroundColor: "#eeeeee",
        center: new google.maps.LatLng(37.780015, -122.446937),
        zoom: 13,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        streetViewControl: false,
        panControl: false,
        rotateControl: false,
        zoomControl: true,
        mapTypeControl: false,
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.SMALL,
          overviewMapControl: false,
          mapTypeControl: false,
          position: google.maps.ControlPosition.RIGHT_TOP
        }
      };
      Restangular.one('operations').getList().then(function(operations) {
        return $scope.operations = operations;
      });
      $scope.$watch("selection", function() {
        if ($scope.selection) {
          return $location.path("/search/" + $scope.selection);
        }
      });
      $scope.$on('$locationChangeSuccess', function(event) {
        $scope.selection = $window.location.hash.split("/")[2];
        $rootScope.page = $scope.page = $window.location.hash.split("/")[1];
        return console.log("$locationChangeSuccess", $scope.selection);
      });
      $scope.onMapReady = function() {
        return $rootScope.$watch("results", function() {
          var m, result, results, _i, _j, _len, _len1, _ref, _results;

          results = $rootScope.results;
          if (results && results.length && !$scope.mapLoaded) {
            $scope.mapLoaded = true;
            _ref = $scope.markers;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              m = _ref[_i];
              m.setMap(null);
            }
            $scope.markers = [];
            _results = [];
            for (_j = 0, _len1 = results.length; _j < _len1; _j++) {
              result = results[_j];
              _results.push(geocoder.geocode("" + result.street + ", " + result.city).then(function(location) {
                result.lat = location.lat();
                result.lng = location.lng();
                return $scope.addMarker(result);
              }));
            }
            return _results;
          }
        }, true);
      };
      $scope.markerClicked = function(m) {
        $scope.map.panTo(m.position);
        console.log("panTo", m.position.lat(), m.position.lng());
        m.setAnimation(google.maps.Animation.BOUNCE);
        return $timeout(function() {
          return m.setAnimation(null);
        }, 1440);
      };
      $rootScope.clickMarker = function(index) {
        return $scope.markerClicked($scope.markers[index]);
      };
      return $scope.addMarker = function(result) {
        var marker;

        console.log("Adding marker to", result.lng, result.lng);
        marker = new google.maps.Marker({
          map: $scope.map,
          position: new google.maps.LatLng(result.lat, result.lng),
          icon: $scope.pin,
          animation: google.maps.Animation.DROP
        });
        return $scope.markers.push(marker);
      };
    }
  ]);

  controllers.controller("HomeCtrl", [
    "$scope", "Restangular", "$location", function($scope, Restangular, $location) {
      return $scope.search = function() {
        if ($scope.selection) {
          return $location.path("/search/" + $scope.selection);
        }
      };
    }
  ]);

  controllers.controller("SearchCtrl", [
    "$scope", "$routeParams", "Restangular", "geocoder", "$rootScope", function($scope, $routeParams, Restangular, geocoder, $rootScope) {
      if ($routeParams.operation) {
        Restangular.one('hospitals', $routeParams.operation).getList().then(function(results) {
          return $rootScope.results = $scope.results = results;
        });
      }
      return $scope.selectResult = function(result, index) {
        $scope.selectedResult = result;
        $rootScope.clickMarker(index);
        return console.log("Selecting " + index);
      };
    }
  ]);

}).call(this);
