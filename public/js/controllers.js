// Generated by CoffeeScript 1.6.2
(function() {
  var controllers;

  controllers = angular.module('app.controllers', []);

  controllers.controller("MainCtrl", [
    "$scope", "Restangular", "$window", "$location", "$rootScope", "geocoder", "$timeout", function($scope, Restangular, $window, $location, $rootScope, geocoder, $timeout) {
      var _this = this;

      $scope.pin = new google.maps.MarkerImage("/images/pin.png", null, null, null, new google.maps.Size(35, 35));
      $scope.markers = [];
      $scope.mapOptions = {
        backgroundColor: "#eeeeee",
        center: new google.maps.LatLng(37.780015, -122.446937),
        zoom: 12,
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        streetViewControl: false,
        panControl: false,
        rotateControl: false,
        zoomControl: true,
        mapTypeControl: false,
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.SMALL,
          overviewMapControl: false,
          mapTypeControl: false,
          position: google.maps.ControlPosition.RIGHT_BOTTOM
        }
      };
      Restangular.one('operations').getList().then(function(operations) {
        return $scope.operations = operations;
      });
      $scope.$watch("selection", function() {
        if ($scope.selection) {
          return $location.path("/search/" + $scope.selection);
        }
      });
      $scope.$on('$locationChangeSuccess', function(event) {
        $scope.selection = $window.location.hash.split("/")[2];
        return $rootScope.page = $scope.page = $window.location.hash.split("/")[1];
      });
      $scope.onMapReady = function() {
        return $rootScope.$watch("results", function() {
          var m, result, results, _i, _j, _len, _len1, _ref, _results;

          results = $rootScope.results;
          if (results && results.length && !$scope.mapLoaded) {
            $scope.mapLoaded = true;
            _ref = $scope.markers;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              m = _ref[_i];
              m.setMap(null);
            }
            $scope.markers = [];
            _results = [];
            for (_j = 0, _len1 = results.length; _j < _len1; _j++) {
              result = results[_j];
              result.lat = result.loc[0];
              result.lng = result.loc[1];
              _results.push($scope.addMarker(result));
            }
            return _results;
          }
        }, true);
      };
      $scope.markerClicked = function(m) {
        $scope.map.panTo(m.position);
        m.setAnimation(google.maps.Animation.BOUNCE);
        $rootScope.selectResultByIndex($scope.markers.indexOf(m));
        return $timeout(function() {
          return m.setAnimation(null);
        }, 1440);
      };
      $rootScope.clickMarker = function(index) {
        $scope.markerClicked($scope.markers[index]);
        return $rootScope.selectResultByIndex(index);
      };
      return $scope.addMarker = function(result) {
        var marker;

        marker = new google.maps.Marker({
          map: $scope.map,
          position: new google.maps.LatLng(result.lat, result.lng),
          icon: $scope.pin,
          animation: google.maps.Animation.DROP
        });
        return $scope.markers.push(marker);
      };
    }
  ]);

  controllers.controller("HomeCtrl", [
    "$scope", "Restangular", "$location", function($scope, Restangular, $location) {
      return $scope.search = function() {
        if ($scope.selection) {
          return $location.path("/search/" + $scope.selection);
        }
      };
    }
  ]);

  controllers.controller("SearchCtrl", [
    "$scope", "$routeParams", "Restangular", "geocoder", "$rootScope", "$location", function($scope, $routeParams, Restangular, geocoder, $rootScope, $location) {
      if ($routeParams.operation) {
        if ($routeParams.order === "rating") {
          $scope.orderByRatings = true;
          Restangular.one('hospitals', $routeParams.operation).customGETLIST("", {
            order: "rating"
          }).then(function(results) {
            return $rootScope.results = $scope.results = results;
          });
        } else {
          $scope.orderByRatings = false;
          Restangular.one('hospitals', $routeParams.operation).getList().then(function(results) {
            return $rootScope.results = $scope.results = results;
          });
        }
      }
      $scope.selectResult = function(result, index) {
        $scope.selectedResult = result;
        return $rootScope.clickMarker(index);
      };
      $rootScope.selectResultByIndex = function(index) {
        return $scope.selectedResult = $scope.results[index];
      };
      $scope.search = function() {
        $scope.orderByRatings = false;
        if ($routeParams.operation) {
          return $location.path("/search/" + $routeParams.operation);
        }
      };
      return $scope.searchRatings = function() {
        $scope.orderByRatings = true;
        if ($routeParams.operation) {
          return $location.path("/search/" + $routeParams.operation + "/rating");
        }
      };
    }
  ]);

}).call(this);
